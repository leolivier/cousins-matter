{% extends "cm_main/base.html" %}
{% load i18n cm_tags %}
{% block title %}{% title _("Chat") %} {% endblock %}
{% block content %}
<div class="container">
	<h1 class="title">{% title _("Chat") %}</h1>
	<p class="content">{%trans 'Choose an existing room or create a new one.'%}</p>

	<nav class="panel">
		<p class="panel-heading">{%trans 'Rooms' %}</p>
		<div class="panel-block">{%paginate page%}</div>
		{% for room in page.object_list %}
			{%if room.first_message_author%}
			<div class="panel-block">
				<figure class="image mini-avatar mr-2">
					<img class="is-rounded" src="{{room.first_message_author.avatar_mini_url}}" alt="{{room.first_message_author.username}}">
				</figure>
				<p class="content">
					{%trans "Created by:"%}<br>
					<span class="has-text-primary has-text-weight-bold has-text-right mr-5">
					 {{room.first_message_author.username}}
					<a href="{%url 'members:detail' room.first_message_author.id %}" aria-label="{%trans 'profile'%}">
						<span class="icon"><i class="mdi mdi-open-in-new"></i></span>
					</a>
					<br>
					<span class="tag mr-3">{%blocktranslate with nmsgs=room.num_messages%}{{nmsgs}} message(s){%endblocktranslate%}</span>
				</p>
				<a class="title is-size-6" href="{%url 'chat:room' room.slug %}">{{room.name}}</a> 
			</div>
			{%else%}
			<a class="panel-block" href="{%url 'chat:room' room.slug %}">
				<span class="panel-icon">
					<i class="mdi mdi-24px mdi-chat-outline" aria-hidden="true"></i>
				</span>
				<span class="tag mr-3">{%blocktranslate with nmsgs=room.num_messages%}{{nmsgs}} message(s){%endblocktranslate%}</span>
				<span class="title is-size-6">{{room.name}}</span> 
			</a>
			{%endif%}
		{%endfor%}
		<div class="panel-block">
			<p class="control has-icons-left">
				<input class="input" type="text" placeholder="{%trans 'Room name'%}" id="room-name-input">
				<span class="icon is-left">
					<i class="mdi mdi-24px mdi-chat-plus" aria-hidden="true"></i>
				</span>
			</p>
			<div class="control">
				<a class="button is-primary" id="room-name-submit">
					<span class="icon">
						<i class="mdi mdi-24px mdi-chat-plus-outline" aria-hidden="true"></i>
					</span>
					<span class="is-hidden-mobile">{%trans 'Create room' %}</span>
				</a>
			</div>0
		</div>
	</nav>
</div>

<script>
$(document).ready(() => {
	$('#room-name-input').focus();

	$('#room-name-input').on('keyup', (e) => {
		if (e.keyCode === 13) {
			$('#room-name-submit').trigger('click');
  	}
	});

	$('#room-name-submit').on('click', (e) => {
	  var roomName = encodeURIComponent($('#room-name-input').val());
	  window.location.replace('{%url "chat:new_room"%}?name='+roomName);
	});
});
</script>
{% endblock %}
