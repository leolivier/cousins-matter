{% load i18n crispy_forms_tags cm_tags %}
{%with message.comment_set.all as comments %}
<div class="container px-2">
	{%if comments %}
	<h2 class="is-5 mt-1">{% trans "comments" %}</h2>
	<hr style="margin: 0 0;">
	{% for comment in comments %}
	{%partialdef forum_comment inline %}
	<div class="container" id="comment-div-{{comment.id}}">
		{%if edit_comment and edit_comment != 'false'%}
		<form method="POST" class="comment-form" id='edit-comment-{{comment.id}}'
				hx-post="{% url 'forum:edit_comment' comment.id %}"
				hx-target="#comment-div-{{comment.id}}"
		>
			<div class="level">
				<div class="level-left">
					<div class="level-item">{{comment_form|crispy}}</div>
					<div class="level-item ml-4">
						<div class="buttons">
							<button type="submit" class="button is-link" title="{%trans 'Update' %}">
								{%icon "submit" %}
							</button>
							<button type="button" class="button"
								hx-get="{% url 'forum:edit_comment' comment.id %}"
								hx-target="#comment-div-{{comment.id}}"
								hx-vals='{"edit_comment": false}'>
								{%icon "cancel" %}
							</button>
						</div>
					</div>
				</div>
			</div>
		</form>
		{%else%}
			{%include "forum/comment_list.html#display_comment" with comment=comment%}
		{%endif%}
	</div>
	{%endpartialdef forum_comment%}
	{% endfor %}
	{%endif%}
	<div id="next-comment-{{message.id}}"></div>
	<span class="tag" id="nb-comments-id-{{message.id}}">
	{%blocktranslate count ncomments=message.comment_set.count trimmed %}
		{{ncomments}} comment
	{%plural%}
		{{ncomments}} comments
	{%endblocktranslate%}
	</span>
	<a hx-get="{%url 'forum:add_comment' message.id %}"
		hx-target="#create-comment-{{message.id}}"
		title="{%trans 'Add comment' %}">
		{%icon "new-comment"%}
	</a>
	<div id="create-comment-{{message.id}}"></div>
</div>
{%endwith%}

{%partialdef display_comment%}
{# display one comment #}
<div class="level display-comment" id="comment-level-{{comment.id}}">
	<div class="level-left">
		<div class="level-item ml-5">
			<div class="block">
				<p class="content is-small mb-1">
					{{comment.content}}
					<br class="mb-1"/>
					{{comment.created}}
					<a href="{%url 'members:detail' comment.author.id %}">
						{{comment.author.get_full_name}}
					</a>
					<hr class="mt-0 mb-0">
				</p>
			</div>
		</div>
		{% if comment.author.username == user.username %}
		<div class="level-item ml-4 mt-1">
			<div class="buttons">
				<button class="button is-small" type="button"
					hx-get="{% url 'forum:edit_comment' comment.id %}"
					hx-target="#comment-div-{{comment.id}}"
					title="{%trans 'Edit' %}">
					{%icon "edit"%}
				</button>
				<button type="button" class="button is-small"
					hx-post="{% url 'forum:delete_comment' comment.id %}"
					hx-target="#comment-div-{{comment.id}}"
					hx-swap="delete"
					hx-confirm="{%trans 'Are you sure you want to delete this comment?'%}">
					{%icon "delete"%}
				</button>
			</div>
		</div>
		{%endif%}
	</div>
</div>
{%endpartialdef display_comment%}

{%partialdef forum_add_comment%}
<form hx-post="{%url 'forum:add_comment' message.id %}"
			hx-target="#next-comment-{{message.id}}"
			hx-swap="beforebegin"
			hx-vals='{"delta": 1}'
			id="create-comment-{{message.id}}" method="POST" class="comment-form">
	<div class="level">
		<div class="level-left">{{comment_form|crispy}}</div>
		<div class="level-right">
			<div class="buttons">
				<input type="submit" class="button is-link" value="{%trans 'Add'%}">
				<button type="button" class="button"
					hx-get="{% url 'forum:add_comment' message.id %}"
					hx-target="#create-comment-{{message.id}}">
					{%icon "cancel" %}
				</button>
			</div>
		</div>
	</div>
</form>
{%endpartialdef forum_add_comment%}
