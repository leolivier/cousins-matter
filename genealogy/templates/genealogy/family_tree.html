{% extends "genealogy/base_genealogy.html" %}
{% load i18n %}

{% block genealogy_content %}
<div class="box">
    <div class="level">
        <div class="level-left">
            <h2 class="subtitle">{% trans "Family Tree" %}</h2>
        </div>
        <div class="level-right">
            <div class="buttons">
                <button class="button is-small" onclick="resetZoom()">
                    <span class="icon"><i class="fas fa-compress-arrows-alt"></i></span>
                    <span>{% trans "Reset" %}</span>
                </button>
            </div>
        </div>
    </div>
    <div id="tree-container" style="width: 100%; height: 700px; border: 1px solid #eee; border-radius: 4px; overflow: hidden; background: #fcfcfc;"></div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    const container = document.getElementById('tree-container');
    const width = container.clientWidth;
    const height = container.clientHeight;

    const svg = d3.select("#tree-container").append("svg")
        .attr("width", width)
        .attr("height", height)
        .call(d3.zoom().on("zoom", (event) => {
            g.attr("transform", event.transform);
        }))
        .append("g");

    const g = svg.append("g");

    // Arrow marker
    svg.append("defs").selectAll("marker")
        .data(["end"])
        .enter().append("marker")
        .attr("id", String)
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 25)
        .attr("refY", 0)
        .attr("markerWidth", 6)
        .attr("markerHeight", 6)
        .attr("orient", "auto")
        .append("path")
        .attr("d", "M0,-5L10,0L0,5");

    const simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(d => d.id).distance(100))
        .force("charge", d3.forceManyBody().strength(-400))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("y", d3.forceY(0).strength(0.05))
        .force("x", d3.forceX(0).strength(0.05));

    d3.json("{% url 'genealogy:tree_data' %}").then(data => {
        const link = g.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(data.links)
            .enter().append("line")
            .attr("stroke", "#999")
            .attr("stroke-opacity", 0.6)
            .attr("stroke-width", d => d.type === 'partner' ? 2 : 1.5)
            .attr("stroke-dasharray", d => d.type === 'partner' ? "5,5" : null)
            .attr("marker-end", d => d.type === 'parent' ? "url(#end)" : null);

        const node = g.append("g")
            .attr("class", "nodes")
            .selectAll("g")
            .data(data.nodes)
            .enter().append("g")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        node.append("circle")
            .attr("r", 10)
            .attr("fill", d => {
                if (d.sex === 'M') return "#3298dc"; // Bulma info
                if (d.sex === 'F') return "#f14668"; // Bulma danger
                return "#00d1b2"; // Bulma primary
            })
            .attr("stroke", "#fff")
            .attr("stroke-width", 2);

        node.append("text")
            .attr("dx", 15)
            .attr("dy", 4)
            .text(d => d.name)
            .style("font-size", "12px")
            .style("font-family", "sans-serif")
            .style("pointer-events", "none")
            .style("text-shadow", "0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff");

        node.on("click", (event, d) => {
            window.location.href = d.url;
        });
        node.append("title").text(d => d.name);

        simulation
            .nodes(data.nodes)
            .on("tick", ticked);

        simulation.force("link")
            .links(data.links);

        function ticked() {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node
                .attr("transform", d => `translate(${d.x},${d.y})`);
        }
    });

    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }

    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }

    function resetZoom() {
        svg.transition().duration(750).call(
            d3.zoom().transform,
            d3.zoomIdentity,
            d3.zoomTransform(svg.node()).invert([width / 2, height / 2])
        );
    }
</script>
{% endblock %}
