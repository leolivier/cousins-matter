{% extends "members/base_members.html" %}
{% load i18n crispy_forms_tags cm_tags static %}
{% block title %}{% title title %} {% endblock %}
{% block header %}
	<script src="{% static 'cm_main/js/cm_modal.js' %}"></script>
	{%include "cm_main/common/include-bulma-calendar.html" %}
	{%include "cm_main/common/include-summernote.html" with maxsize=settings.MESSAGE_MAX_SIZE %}
{%endblock%}
{% block content %}
{%with member=form.instance%}
<div class="container px-2">
	<h1 class="title has-text-centered is-2">{{title}}</h1>
	{% if member and member.id %} {# existing member #}
	<div class="level px-2 my-2">
		<div class="level-left">
    	<figure class="image thumbnail">
        <img class="is-rounded" src="{{ member.avatar_url }}">
    	</figure>
		</div>
    <div class="level-item">
      <p class="content"><strong>{{ member.get_full_name }}</strong>
				({{member.username}})
			{%if member.email %}<small>&lt;{{ member.email }}&gt;</small>{% endif %}
			<br>
			{%if member.id != request.user.id %}
				{%if member.is_active %}
					{% translate "Active member" %}
				{% else %}
					{% translate "Managed member" %}
				{% endif %}
			{% endif %}
			</p>
    </div>
		<div class="level-right is-flex-shrink-1">
			<div class="buttons is-centered">
				{% if member.id == request.user.id %}{# profile update #}
				<a class="button" href="{% url 'change_password' %}">
					{%icon "change-password" %}
					<span>{% translate "Change Password" %}</span>
				</a>
				{%elif member.member_manager and member.member_manager.id == request.user.id %} {# update managed member #}
				<a class="button" href="{% url 'members:activate' pk %}">
					{%icon "activate-member" %}
					<span>{% translate "Activate Account" %}</span>
				</a>
				{% endif %}
				<button class="button js-modal-trigger" data-target="delete-item-modal" title="{%trans 'Delete' %}">
					{%icon "delete" %}
					<span>
						{% if member.id == request.user.id %}{# profile update #}
						{%trans "Remove my account" %}
						{% else %}
						{%trans "Delete member" %}
						{% endif %}
					</span>
				</button>
			</div>
		</div>
  </div>
	{% endif %}
	<div class="container px-2">
		<form enctype="multipart/form-data" method="post">
			{% csrf_token %}
			{{ form | crispy }}
			<div class="buttons is-centered">
				<button type="submit" class="button is-dark">
				{%if form.instance.pk %}
					{%icon "update"%}
					<span>{%translate "Update" %}</span>
				{%else%}
					{%icon "create"%}
					<span>{%translate "Create" %}</span>
				{%endif%}
				</button>
			</div>
		</form>
	</div>
	<div class="container mt-4 has-text-centered">
			{% translate 'Lost your verification email?' %} 
			<a href="{% url 'request-new-link-from-email' %}" class="is-small">
					{% translate "Request a new link" %}
			</a>
	</div>
</div>
	{% block modals %}
	{% with template="cm_main/common/modal_form.html" %}

		{% url 'members:modal_create_address' as create_address_url %}
		{% include template with modal_id="create-address-modal" title=_("New Address") action_url=create_address_url form=new_addr_form success_function='add_address_to_options' %}

		{% if member.address %}
			{% url 'members:modal_update_address' settings.OBJECT_ID_PLACEHOLDER as change_address_url %}
			{% url 'members:get_address' settings.OBJECT_ID_PLACEHOLDER as get_address_url %}
			{% with modal_id="change-address-modal" title=_("Change Address") action_url=change_address_url %}
			{% with form=addr_form success_function='change_address_option' opener_element='#id_change_address_link' %}
			{% with init_function='update_change_address_form' get_url=get_address_url %}
			{% include template with modal_id=modal_id title=title action_url=action_url form=form success_function=success_function opener_element=opener_element init_function=init_function get_url=get_url %} 
			{%endwith%}{%endwith%}{%endwith%}

		{% endif %}

		{% url 'members:modal_create_family' as create_family_url %}
		{% with modal_id="create-family-modal" title=_("New Family") action_url=create_family_url %}
		{% with form=new_family_form success_function='add_family_to_options' opener_element='#id_create_family_link' %}
		{% with init_function=update_change_family_form get_url=get_family_url %}
		{% include template with modal_id=modal_id title=title action_url=action_url form=form success_function=success_function %} 
		{% with modal_id="create-parent-family-modal" title=_("New Parent Family") success_function='add_parent_family_option' above="#create-family-modal"%}
		{% include template with modal_id=modal_id title=title action_url=action_url form=form success_function=success_function opener_element=opener_element init_function=init_function get_url=get_url %} 
		{%endwith%}{%endwith%}{%endwith%}{%endwith%}

		{% if member.family %}
			{% url "members:modal_update_family" settings.OBJECT_ID_PLACEHOLDER as change_family_url %}
			{% url 'members:get_family' settings.OBJECT_ID_PLACEHOLDER as get_family_url %}
			{% with modal_id="change-family-modal" title=_("Change Family") action_url=change_family_url %}
			{% with form=family_form success_function='change_family_option' opener_element='#id_change_family_link' %}
			{% with init_function='update_change_family_form' get_url=get_family_url %}
			{% include template with modal_id=modal_id title=title action_url=action_url form=form success_function=success_function opener_element=opener_element init_function=init_function get_url=get_url %} 
			{%endwith%}{%endwith%}{%endwith%}
		{% endif %}

	{%endwith%}
	{% endblock modals %}

	{% block javascript %}
		<script>
			function add_address_to_options(response) {
				add_selected_option('#id_address', response.id, response.address_str, '{%trans "Address created" %}');
			}
			function change_address_option(response) {
				change_option('#id_address', response.id, response.address_str, '{%trans "Address updated" %}');
			}
			function update_change_address_form(response) {
				form = $('#change-address-modal-form')
				form.find('#updt_id_number_and_street').val(response.number_and_street)
				form.find('#updt_id_complementary_info').val(response.complementary_info)
				form.find('#updt_id_zip_code').val(response.zip_code)
				form.find('#updt_id_city').val(response.city)
				form.find('#updt_id_country').val(response.country)
			}
			function update_change_family_form(response) {
				form = $('#change-family-modal-form')
				form.find('#').val(response.family_name)
				form.find('select').val(response.parent_family_id)
			}
			function add_family_to_options(response) {
				add_selected_option('#id_family', response.family_id, response.family_name, '{%trans "Family created" %}');
			}
			function add_parent_family_option(response) {
				add_selected_option('#updt_id_parent', response.family_id, response.family_name, '{%trans "Parent family created" %}');
			}
			function change_family_option(response) {
				change_option('#id_family', response.family_id, response.family_name, '{%trans "Family updated" %}');
			}
			$(document).ready(function() {
				// check user name is not taken for self registration
				add_ajax_checker('id_username', "{% url 'members:validate_username' %}", "is_taken", "{% translate 'This username is not available!' %}")
				{%if member.address.id%}
				// set id on address update opener
				$('#div_id_address a.change-related').data('id', '{{member.address.id}}')
				// update change address form id when new address selected
				$('#div_id_address select').change(function() {
					new_id = $(this).val()
					$('#div_id_address a.change-related').data('id', new_id)
				});
				{%endif%}
				{%if member.family.id%}
				// set id on family update opener
				$('#div_id_family a.change-related').data('id', '{{member.family.id}}')
				// update change family form id when new family selected
				$('#div_id_family select').change(function() {
					new_id = $(this).val()
					$('#div_id_family a.change-related').data('id', new_id)
				});
				// same but for parent family update in change family dialog
				$('#div_updt_id_parent select').change(function() {
					new_id = $(this).val()
					$('#div_updt_id_parent a.change-related').data('id', new_id)
				});
				{%endif%}
			});
		</script>
	{% endblock javascript %}
	{%if member and member.id %}
		{% if form.instance.id == request.user.id %}{# profile removal #}
			{% trans "Delete My Account" as delete_title %}
			{% trans "Are you sure you want to delete your account and all associated data? This is irrecoverable!" as delete_msg %}
		{%else%}{# managed member removal #}
			{% trans "Delete Member" as delete_title %}
			{% blocktranslate asvar delete_msg with name=member.get_full_name trimmed %}Are you sure you want to delete {{ name }}'s account and all associated data?{% endblocktranslate %}
		{%endif%}
		{% url 'members:delete' member.id as delete_url %}
		{%include "cm_main/common/confirm-delete-modal.html" with ays_title=delete_title ays_msg=delete_msg action_url=delete_url expected_value=member.username %}
	{%endif%}
{%endwith%}
{% endblock content %}
